<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Formulario</title>
    <style>
        body {
            background-color: white;
            color: black;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .form-container {
            width: 100%;
            padding: 10px;
        }
        h1 {
            text-align: left;
            color: black;
        }
        .form-group {
            margin-bottom: 10px;
        }
        input, select, button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 5px;
        }
        button {
            background-color: gray;
            color: white;
            border: none;
        }
        button:hover {
            background-color: darkgray;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Crear Formulario</h1>
        <form method="POST" action="/enviar_formulario">
            <fieldset disabled>
                <div class="form-group">
                    <label for="num_atencion">Número de Atención</label>
                    <input type="text" id="num_atencion" placeholder="{{ num_atencion }}">
                </div>
            </fieldset>
            <input type="hidden" name="num_atencion" value="{{ num_atencion }}">
            <div class="form-group">
                <label for="cne">CNE</label>
                <select id="cne" name="cne">
                    <option selected disabled></option>
                    <option value="8">Compraventa</option>
                    <option value="99">Regularización de Patrimonio</option>
                </select>
            </div>
            <div class="form-group">
                <label for="region">Región</label>
                <select id="region" name="region">
                    <option selected disabled></option>
                    {% for region in regiones %}
                        <option value="{{ region.id }}">{{ region.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="comuna">Comuna</label>
                <select id="comuna" name="comuna" disabled>
                    <option selected disabled></option>
                </select>
            </div>
            <div class="form-group">
                <label for="manzana">Manzana</label>
                <input type="number" id="manzana" name="manzana">
            </div>
            <div class="form-group">
                <label for="predio">Predio</label>
                <input type="number" id="predio" name="predio">
            </div>
            <div class="form-group">
                <button type="button" id="add_enajenante">+ Agregar Enajenante</button>
                <div id="enajenantes"></div>
            </div>
            <div class="form-group">
                <button type="button" id="add_adquirente">+ Agregar Adquirente</button>
                <div id="adquirentes"></div>
            </div>
            <div class="form-group">
                <label for="fojas">Fojas</label>
                <input type="number" id="fojas" name="fojas">
            </div>
            <div class="form-group">
                <label for="fecha_ins">Fecha de inscripción</label>
                <input type="datetime-local" id="fecha_ins" name="fecha_ins">
            </div>
            <div class="form-group">
                <label for="num_ins">Número de inscripción</label>
                <input type="number" id="num_ins" name="num_ins">
            </div>
            <button type="submit" id="submit-form">Enviar</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {            
            document.getElementById('region').addEventListener('change', function() {
                var regionId = this.value;
                var comunaSelect = document.getElementById('comuna');
                comunaSelect.innerHTML = '';
                fetch(`/comunas/${regionId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(comuna => {
                            var option = document.createElement('option');
                            option.value = comuna.id;
                            option.textContent = comuna.nombre;
                            comunaSelect.appendChild(option);
                        });
                    });
                if (regionId) {
                    comunaSelect.disabled = false;
                    comunaSelect.innerHTML = '<option selected disabled></option>';
                } else {
                    comunaSelect.disabled = true;
                    comunaSelect.innerHTML = '<option selected disabled>Seleccionar Región primero</option>';
                }
            });

            function agregarCampo(tipo) {
                var container = tipo === 'enajenante' ? document.getElementById('enajenantes') : document.getElementById('adquirentes');
                var label = tipo === 'enajenante' ? 'Enajenante' : 'Adquirente';
    
                var newDiv = document.createElement('div');
    
                var labelElement = document.createElement('label');
                labelElement.textContent = label;
    
                var rutInput = document.createElement('input');
                rutInput.setAttribute('type', 'text');
                rutInput.setAttribute('name', tipo + '_rut[]');
                rutInput.setAttribute('placeholder', 'RUT');
    
                var porcentajeInput = document.createElement('input');
                porcentajeInput.setAttribute('type', 'text');
                porcentajeInput.setAttribute('name', tipo + '_porcentaje[]');
                porcentajeInput.setAttribute('placeholder', '% de derecho');   
    
                var removeButton = document.createElement('button');
                removeButton.textContent = 'Eliminar';
                removeButton.onclick = function() {
                    container.removeChild(newDiv);
                };
    
                newDiv.appendChild(labelElement);
                newDiv.appendChild(rutInput);
                newDiv.appendChild(porcentajeInput);
                newDiv.appendChild(removeButton);
    
                container.appendChild(newDiv);
            }
            
            document.getElementById('add_enajenante').addEventListener('click', function() {
                agregarCampo('enajenante');
            });
    
            document.getElementById('add_adquirente').addEventListener('click', function() {
                agregarCampo('adquirente');
            });
        });
    </script>
</body>
</html>
